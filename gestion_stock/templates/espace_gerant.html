{% extends "base.html" %}
{% load static %}

{% block title %}{{ titre_espace }} - SuccessFuel{% endblock %}

{% block sidebar_nav %}
<!-- Navigation spécifique pour le gérant de station -->
<a href="#" class="nav-item active" onclick="showSection('dashboard-section')">
  <i class="fa-solid fa-chart-line"></i>
  <span>Dashboard</span>
</a>
<a href="#" class="nav-item" onclick="showSection('stations-section')">
  <i class="fa-solid fa-building"></i>
  <span>Mes stations</span>
</a>
<a href="#" class="nav-item" onclick="showSection('approvisionnements-section')">
  <i class="fa-solid fa-truck-loading"></i>
  <span>Approvisionnements</span>
</a>
<a href="#" class="nav-item" onclick="showSection('ventes-section')">
  <i class="fa-solid fa-cash-register"></i>
  <span>Ventes</span>
</a>
<a href="#" class="nav-item" onclick="showSection('stocks-section')">
  <i class="fa-solid fa-warehouse"></i>
  <span>Stocks</span>
</a>
<a href="#" class="nav-item">
  <i class="fa-solid fa-gear"></i>
  <span>Paramètres</span>
</a>
{% endblock %}

{% block content %}
<!-- Tableau de bord -->
<div id="dashboard-section" class="section-content">
  <!-- Stats Section -->
  <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Statistiques du jour</h2>
  <div class="grid grid-cols-4 mb-6">
    <div class="stat-card">
      <div class="stat-icon primary">
        <i class="fa-solid fa-water"></i>
      </div>
      <div class="stat-value">12,450 L</div>
      <div class="stat-label">Volume Vendu</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon secondary">
        <i class="fa-solid fa-euro-sign"></i>
      </div>
      <div class="stat-value">48,560 €</div>
      <div class="stat-label">CA Journalier</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon accent">
        <i class="fa-solid fa-boxes-stacked"></i>
      </div>
      <div class="stat-value">42,300 L</div>
      <div class="stat-label">Stock Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple">
        <i class="fa-solid fa-bell"></i>
      </div>
      <div class="stat-value">2</div>
      <div class="stat-label">Alertes Stock</div>
    </div>
  </div>

  <!-- Charts Section -->
  <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Graphiques</h2>
  <div class="grid grid-cols-2">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Évolution des Ventes</h3>
        <p class="card-description">Analyse des tendances sur 6 mois</p>
      </div>
      <canvas id="salesChart" style="max-height: 300px;"></canvas>
    </div>

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Évolution des Achats</h3>
        <p class="card-description">Analyse des tendances sur 6 mois</p>
      </div>
      <canvas id="purchaseChart" style="max-height: 300px;"></canvas>
    </div>
  </div>
</div>

<!-- Mes stations -->
<div id="stations-section" class="section-content" style="display: none;">
  <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Mes Stations</h2>
  <div class="grid grid-cols-3">
    {% if stations %}
      {% for station in stations %}
        <div class="tank-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="card-title">{{ station.nom }}</h3>
            <span class="stat-value">Opérationnel</span>
          </div>
          <div class="text-muted small mb-2">
            <i class="fa-solid fa-location-dot"></i>
            Antananarivo
          </div>
          <div class="text-muted small">
            <i class="fa-solid fa-user"></i>
            {{ user.utilisateur.prenom }} {{ user.utilisateur.nom }}
          </div>
          <div class="mt-3">
            <a href="#" class="btn btn-outline">Détails</a>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info">
        <i class="fa-solid fa-info-circle"></i>
        <div>
          <strong>Aucune station</strong>
          <p>Vous ne gérez aucune station pour le moment.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Approvisionnements -->
<div id="approvisionnements-section" class="section-content" style="display: none;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Approvisionnements</h2>
    <div class="flex gap-2">
      <button class="btn btn-outline active" onclick="showSubSection('achats')">Carburants</button>
      <button class="btn btn-outline" onclick="showSubSection('lubrifiants')">Lubrifiants</button>
    </div>
  </div>

  <div id="achats-subsection">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="card-title">Achats de Carburants</h3>
      <a href="#" class="btn btn-primary">Ajouter</a>
    </div>
    <div class="card">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Produit</th>
              <th>Quantité (L)</th>
              <th>Fournisseur</th>
              <th>Facture</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2026-01-15</td>
              <td>Super Plombé</td>
              <td>10,000</td>
              <td>Compagnie A</td>
              <td>FACT-2026-001</td>
              <td>
                <button class="btn btn-outline">Détails</button>
              </td>
            </tr>
            <tr>
              <td>2026-01-10</td>
              <td>Gazole</td>
              <td>8,000</td>
              <td>Compagnie B</td>
              <td>FACT-2026-002</td>
              <td>
                <button class="btn btn-outline">Détails</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="lubrifiants-subsection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="card-title">Achats de Lubrifiants</h3>
      <a href="#" class="btn btn-primary">Ajouter</a>
    </div>
    <div class="card">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Produit</th>
              <th>Quantité</th>
              <th>Fournisseur</th>
              <th>Facture</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2026-01-12</td>
              <td>Huile moteur 15W40</td>
              <td>200</td>
              <td>Distributeur X</td>
              <td>FACT-LUB-2026-001</td>
              <td>
                <button class="btn btn-outline">Détails</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Ventes -->
<div id="ventes-section" class="section-content" style="display: none;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Ventes</h2>
    <div class="flex gap-2">
      <button class="btn btn-outline active" onclick="showVenteSubSection('ventes-carburants')">Carburants</button>
      <button class="btn btn-outline" onclick="showVenteSubSection('ventes-lubrifiants')">Lubrifiants</button>
    </div>
  </div>

  <div id="ventes-carburants-subsection">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="card-title">Ventes de Carburants</h3>
      <a href="#" class="btn btn-primary">Ajouter</a>
    </div>
    <div class="card">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Pistolet</th>
              <th>Produit</th>
              <th>Quantité (L)</th>
              <th>Index Début</th>
              <th>Index Fin</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2026-01-17</td>
              <td>Pistolet 1</td>
              <td>Super Plombé</td>
              <td>45.5</td>
              <td>12500</td>
              <td>12545.5</td>
              <td>
                <button class="btn btn-outline">Détails</button>
              </td>
            </tr>
            <tr>
              <td>2026-01-17</td>
              <td>Pistolet 3</td>
              <td>Gazole</td>
              <td>32.0</td>
              <td>8750</td>
              <td>8782</td>
              <td>
                <button class="btn btn-outline">Détails</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="ventes-lubrifiants-subsection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="card-title">Ventes de Lubrifiants</h3>
      <a href="#" class="btn btn-primary">Ajouter</a>
    </div>
    <div class="card">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Produit</th>
              <th>Quantité</th>
              <th>Prix Unit.</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2026-01-16</td>
              <td>Huile moteur 15W40</td>
              <td>2</td>
              <td>15,000</td>
              <td>30,000</td>
              <td>
                <button class="btn btn-outline">Détails</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Stocks -->
<div id="stocks-section" class="section-content" style="display: none;">
  <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Stocks</h2>
  <div class="grid grid-cols-2">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Cuves</h3>
      </div>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Nom Cuve</th>
              <th>Produit</th>
              <th>Capacité (L)</th>
              <th>Stock Actuel (L)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Cuve 1</td>
              <td>Super Plombé</td>
              <td>20,000</td>
              <td>15,200</td>
              <td>
                <button class="btn btn-outline">Historique</button>
              </td>
            </tr>
            <tr>
              <td>Cuve 2</td>
              <td>Gazole</td>
              <td>20,000</td>
              <td>12,800</td>
              <td>
                <button class="btn btn-outline">Historique</button>
              </td>
            </tr>
            <tr>
              <td>Cuve 3</td>
              <td>Pétrole</td>
              <td>15,000</td>
              <td>8,500</td>
              <td>
                <button class="btn btn-outline">Historique</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Lubrifiants</h3>
      </div>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Produit</th>
              <th>Unité</th>
              <th>Stock Actuel</th>
              <th>Seuil Min</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Huile moteur 15W40</td>
              <td>Carton (12 bidons)</td>
              <td>15</td>
              <td>5</td>
              <td>
                <button class="btn btn-outline">Historique</button>
              </td>
            </tr>
            <tr>
              <td>Liquide frein DOT4</td>
              <td>Bidon (1L)</td>
              <td>28</td>
              <td>10</td>
              <td>
                <button class="btn btn-outline">Historique</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions Section -->
<h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Actions Rapides</h2>
<div class="grid grid-cols-4">
  <a href="#" class="card action-btn">
    <div class="stat-icon primary">
      <i class="fa-solid fa-cart-plus"></i>
    </div>
    <h3 class="card-title">Nouvelle Vente</h3>
  </a>

  <a href="#" class="card action-btn">
    <div class="stat-icon secondary">
      <i class="fa-solid fa-truck"></i>
    </div>
    <h3 class="card-title">Réception Camion</h3>
  </a>

  <a href="#" class="card action-btn">
    <div class="stat-icon accent">
      <i class="fa-solid fa-gauge-high"></i>
    </div>
    <h3 class="card-title">Relevé Index</h3>
  </a>

  <a href="#" class="card action-btn">
    <div class="stat-icon purple">
      <i class="fa-solid fa-lock"></i>
    </div>
    <h3 class="card-title">Clôture Caisse</h3>
  </a>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  // Fonction pour afficher/masquer les sections
  function showSection(sectionId) {
    // Masquer toutes les sections
    document.querySelectorAll('.section-content').forEach(section => {
      section.style.display = 'none';
    });

    // Afficher la section demandée
    document.getElementById(sectionId).style.display = 'block';

    // Mettre à jour les classes actives dans la sidebar
    document.querySelectorAll('.nav-item').forEach(item => {
      item.classList.remove('active');
    });

    // Trouver le lien correspondant dans la sidebar et l'activer
    const sectionName = sectionId.replace('-section', '');
    const navItem = document.querySelector(`[onclick="showSection('${sectionName}-section')"]`);
    if (navItem) {
      navItem.classList.add('active');
    } else {
      // Si aucun lien spécifique n'est trouvé, activer le tableau de bord par défaut
      const dashboardLink = document.querySelector('[onclick="showSection(\'dashboard-section\')"]');
      if (dashboardLink) {
        dashboardLink.classList.add('active');
      }
    }
  }

  // Fonction pour afficher les sous-sections d'approvisionnements
  function showSubSection(subSectionId) {
    // Masquer toutes les sous-sections
    document.getElementById('achats-subsection').style.display = 'none';
    document.getElementById('lubrifiants-subsection').style.display = 'none';

    // Afficher la sous-section demandée
    if (subSectionId === 'achats') {
      document.getElementById('achats-subsection').style.display = 'block';
      document.querySelector('#approvisionnements-section .btn-outline:nth-child(1)').classList.add('active');
      document.querySelector('#approvisionnements-section .btn-outline:nth-child(2)').classList.remove('active');
    } else if (subSectionId === 'lubrifiants') {
      document.getElementById('lubrifiants-subsection').style.display = 'block';
      document.querySelector('#approvisionnements-section .btn-outline:nth-child(2)').classList.add('active');
      document.querySelector('#approvisionnements-section .btn-outline:nth-child(1)').classList.remove('active');
    }
  }

  // Fonction pour afficher les sous-sections de ventes
  function showVenteSubSection(subSectionId) {
    // Masquer toutes les sous-sections
    document.getElementById('ventes-carburants-subsection').style.display = 'none';
    document.getElementById('ventes-lubrifiants-subsection').style.display = 'none';

    // Afficher la sous-section demandée
    if (subSectionId === 'ventes-carburants') {
      document.getElementById('ventes-carburants-subsection').style.display = 'block';
      document.querySelector('#ventes-section .btn-outline:nth-child(1)').classList.add('active');
      document.querySelector('#ventes-section .btn-outline:nth-child(2)').classList.remove('active');
    } else if (subSectionId === 'ventes-lubrifiants') {
      document.getElementById('ventes-lubrifiants-subsection').style.display = 'block';
      document.querySelector('#ventes-section .btn-outline:nth-child(2)').classList.add('active');
      document.querySelector('#ventes-section .btn-outline:nth-child(1)').classList.remove('active');
    }
  }

  // Animation des cuves au chargement
  document.addEventListener('DOMContentLoaded', function() {
    // Par défaut, afficher le tableau de bord
    showSection('dashboard-section');

    const tankFills = document.querySelectorAll('.tank-fill');
    tankFills.forEach(fill => {
      const height = fill.style.height;
      fill.style.height = '0%';
      setTimeout(() => {
        fill.style.height = height;
      }, 100);
    });
  });
  
  // Initialisation des graphiques
  document.addEventListener('DOMContentLoaded', function() {
    // Graphique des ventes
    const salesCtx = document.getElementById('salesChart');
    if (salesCtx) {
      const salesChart = new Chart(salesCtx.getContext('2d'), {
        type: 'line',
        data: {
          labels: ['Août', 'Sept', 'Oct', 'Nov', 'Déc', 'Jan'],
          datasets: [{
            label: 'Ventes (€)',
            data: [12000, 19000, 15000, 22000, 18000, 25000],
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' €';
                }
              }
            }
          }
        }
      });
    }

    // Graphique des achats
    const purchaseCtx = document.getElementById('purchaseChart');
    if (purchaseCtx) {
      const purchaseChart = new Chart(purchaseCtx.getContext('2d'), {
        type: 'line',
        data: {
          labels: ['Août', 'Sept', 'Oct', 'Nov', 'Déc', 'Jan'],
          datasets: [{
            label: 'Achats (€)',
            data: [10000, 14000, 12000, 18000, 15000, 20000],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' €';
                }
              }
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}